<template name="ArticleText">
    <div class="row">
        <div class="page-content col s12 m12 l8">
            {{#with article}}
                {{>ArticleHeader}}

                {{#if ids.pii}}
                {{else}}
                    <div class="center-align"><h4>Full Text Unavailable.</h4></div>
                {{/if}}
            {{/with}}

            {{#if fullText}}
            {{else}}
                {{>Loading}}
            {{/if}}

            {{#with fullText}}
                <div class="article-text">
                    {{>ArticleFullText}}

                    {{#if glossary}}
                        {{>ArticleGlossary}}
                    {{/if}}

                    {{#if acks}}
                        {{#each acks}}
                        <h3 id="{{convertToID title}}" class="article-header-1">{{title}}</h3>
                            {{#each content}}
                                {{#if equals contentType 'p'}}
                                    <p>{{{content}}}</p>
                                {{/if}}
                            {{/each}}
                        {{/each}}
                    {{/if}}


                    {{#if footnotes}}
                        {{#each footnotes}}
                        <h3 id="{{convertToID title}}" class="article-header-1">{{title}}</h3>
                            {{#each content}}
                            <p>{{{.}}}</p>
                            {{/each}}
                        {{/each}}
                    {{/if}}

                    {{#if references}}
                        <h3 id="references">References</h3>
                        <ul>
                            {{#each references}}
                                <li id="R{{number}}">
                                    <b>{{number}}.</b>

                                    {{#if equals type 'journal'}}
                                    {{#if editors}}<span> {{editors}}, editor.</span>{{/if}}
                                    {{#if authors}}<span> {{{authors}}}.</span>{{/if}}
                                    {{#if title}}<span> {{{title}}}.</span>{{/if}}
                                    {{#if source}}<span> {{source}}.</span>{{/if}}
                                    {{#if year}}<span> {{year}};</span>{{/if}}
                                    {{#if volume}}<span> {{volume}}:</span>{{/if}}
                                    {{#if issue}}<span> {{issue}}</span>{{/if}}
                                    {{#if comment}}<span> {{{comment}}}.</span>{{/if}}
                                    {{#if fpage}}<span> {{fpage}}</span>{{/if}}{{#if lpage}}<span>-{{lpage}}</span>.{{/if}}
                                    {{#if pmid}}<span> [<a href="http://www.ncbi.nlm.nih.gov/pubmed/{{pmid}}" target="_BLANK">PubMed</a>]</span>{{/if}}
                                    {{/if}}

                                    {{#if equals type 'book'}}

                                        {{! Book refs are handled differently if they are chapter specific refs}}
                                        {{#if chapter_title}}

                                            {{#if authors}}<span> {{{authors}}}.</span>{{/if}}
                                            {{#if chapter_title}}<span> {{{chapter_title}}}.</span>{{/if}}
                                            {{#if source}}<span>In: </span>{{/if}}
                                            {{#if editors}}<span> {{editors}}, eds.</span>{{/if}}
                                            {{#if source}}<span>{{{source}}}.</span>{{/if}}
                                            {{#if volume}}<span> {{volume}}:</span>{{/if}}
                                            {{#if publisher_loc}}<span>{{{publisher_loc}}}</span>{{/if}}
                                            {{#if publisher_name}}: <span>{{{publisher_name}}}</span>{{/if}}{{#if year}}<span>, {{year}}</span>{{/if}}{{#if fpage}}<span>, pp. {{fpage}}</span>{{/if}}{{#if lpage}}<span>-{{lpage}}</span>{{/if}}<span>.</span>

                                        {{! This is the non-chapter specific ref, for a whole book}}
                                        {{else}}

                                            {{#if authors}}<span> {{{authors}}}.</span>{{/if}}
                                            {{#if year}}<span> ({{year}}).</span>{{/if}}
                                            {{#if chapter_title}}<span> {{{chapter_title}}}.</span>{{/if}}
                                            {{#if fpage}}<span> {{fpage}}</span>{{/if}}{{#if lpage}}<span>-{{lpage}}</span>{{/if}}
                                            {{#if source}}<span>{{{source}}}</span>{{/if}}<span>(</span>{{#if publisher_loc}}<span>{{{publisher_loc}}}</span>{{/if}}{{#if publisher_name}}: <span>{{{publisher_name}}}</span>{{/if}}<span>)</span><span>.</span>
                                        {{/if}}
                                    {{/if}}


                                    {{#if equals type 'web'}}
                                    {{#if authors}}<span> {{{authors}}}.</span>{{/if}}
                                    {{#if title}}<span> {{{title}}}.</span>{{/if}}
                                    {{#if year}}<span> {{year}};</span>{{/if}}
                                    {{#if source}}<span> {{source}}.</span>{{/if}}
                                    {{/if}}

                                    {{#if equals type 'other'}}
                                    {{#if collab}}<span> {{collab}}.</span>{{/if}}
                                    {{#if authors}}<span> {{{authors}}}.</span>{{/if}}
                                    {{#if source}}<span> {{source}}.</span>{{/if}}
                                    {{#if title}}<span> {{{title}}}.</span>{{/if}}
                                    {{#if chapter_title}}<span> {{{chapter_title}}};</span>{{/if}}
                                    {{#if comment}}<span> {{{comment}}}</span>{{/if}}
                                    {{#if year}}<span> {{year}};</span>{{/if}}
                                    {{/if}}

                                    {{#if ext_link}}<a href="{{ext_link}}" target="_BLANK">{{ext_link}}</a>{{/if}}
                                    {{#if comment}}<span>{{{comment}}}</span>{{/if}}
                                </li>
                            {{/each}}
                        </ul>
                    {{/if}}
                </div>
            {{/with}}
        </div>

        {{> ArticleSidebar article=article related=fullText.related}}
    </div>
</template>

<template name="ArticleFullText">
    {{#if advanceContent}}
        {{{advanceContent}}}
    {{else}}
        {{#each sections}}
            {{>ArticleFullTextSection}}
        {{/each}}
    {{/if}}
</template>

<template name="ArticleFullTextSection">
    <div class="section-container" id="{{#if equals headerLevel 1}}{{convertToID title}}{{/if}}">
        <h3 class="article-header-{{headerLevel}}">{{#if label}} {{{label}}}} {{/if}} {{{title}}}</h3>
        {{#each content}}
            {{#if equals contentType 'p'}}
            <p>{{{content}}}</p>
            {{/if}}


            {{#if equals contentType 'subsection'}}
            {{>ArticleFullTextSection}}
            {{/if}}

            {{#if equals contentType 'figure'}}
            <!-- Figure -->
                {{#with content}}
                {{>FullTextFigure}}
                {{/with}}
            {{/if}}

            {{#if equals contentType 'table'}}
            <!-- Table -->
                <div class="article-table">
                    {{{content}}}

                    {{#if tableGraphic}}
                    {{#with tableGraphic}}
                    {{>FullTextFigure}}
                    {{/with}}
                    {{/if}}
                </div>
            {{/if}}

            {{#if equals contentType 'supplement'}}
            <!-- Supplemental -->
                {{#with content}}

                {{#if title}}
                <h3 class="article-header-2">{{{title}}}</h3>
                {{/if}}

                <h3 class="article-header-3"><a href="{{url}}" class="supplemental" id="{{id}}"><span class="icon icon-download"></span> {{#if label}}{{label}}{{else}}Supplemental File{{/if}}</a></h3>

                {{#if caption}}
                <p>{{{caption}}}</p>
                {{/if}}

                {{/with}}
            {{/if}}
        {{/each}}
    </div>
</template>

<template name="FullTextFigure">
    <div class="full-text-image-container" id="{{id}}">
        {{#if label}}<label>{{{label}}}</label>{{/if}}
        {{#if url}}<a href="/figure/?article={{articleId .}}&img={{url}}" target="_blank"><img class="full-text-image" src="{{url}}"/></a>{{/if}}
        {{#if title}}<h4>{{{title}}}</h4>{{/if}}
        {{#if caption}}<p class="small-font">{{{caption}}}</p>{{/if}}
    </div>
</template>

<template name="ArticleGlossary">
    <h3 id="{{convertToID 'Abbreviations'}}" class="article-header-1">Abbreviations</h3>
    <p>
    {{#each glossary}}
        {{{term}}}: {{{def}}};
    {{/each}}
    </p>
</template>
